#!/usr/bin/env bash

set -e

function open_in_acme() {
	IFS=':'; a=($1); unset IFS;
	mkdir -p `dirname ${a[0]}`

	case ${a[1]} in
  	  ''|*[!0-9]*) B ${a[0]} ;;
 	   *) B ${a[0]}:${a[1]} ;;
	esac
}
export -f open_in_acme

dir=$1
[ -z $dir ] && dir=.
cd $dir

SHELL="bash" fzf +m --no-unicode --no-separator --no-scrollbar --no-color \
	--bind alt-r:reload:"sh -c {q}||true" \
	--bind 'ctrl-r:reload(fd --no-ignore)' \
	--bind alt-r:+clear-query \
	--bind alt-c:replace-query \
	--bind 'alt-enter:execute-silent(open_in_acme {q})+close' \
	--bind 'enter:execute-silent(open_in_acme {})+close' \
	--header "$(realpath $dir)
<a-r>:run query|<a-c>:complete query|<a-enter>:open query|<enter>:open selected"


