#!/usr/bin/env -S elvish -norc

use str

var lines = []

try { tiramisu -o "#summary\n#body\n#end\n" } catch { echo "#exit" } | while $true {
  var line = (read-line)

  if (==s $line "#end") {
    var message = (str:join '' $lines)
    try {
      gt sh -c 'printf %s "'$message'"| timeout --foreground 5s less'
    } catch {
      nop
    } finally {
      echo $message
      set lines = []
    }
  } elif (==s $line "#exit") {
    break
  } else {
    set lines = [$@lines $line"\n"]
  }
}
